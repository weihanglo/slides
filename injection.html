<!DOCTYPE html>
<html>
  <head>
    <title>Injection - Top One Security Risk</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style type="text/css" media="screen">
      img {
        max-width: 100%;
        max-height: 100%;
      }
    </style>
  </head>
  <body>
    <textarea id="source">
class: middle, center

# Injection

### Top One Security Risk 

<img 
  style="border-radius: 50px"
  src="https://www.gravatar.com/avatar/67644641ead7ae60a795a14b7e102973?s=100" 
  alt="Weihang Lo">

<a href="https://github.com/weihanglo">@weihanglo</a>

---

## Agenda

- ç‚ºä»€éº¼æˆç«‹è³‡å®‰è®€æ›¸æœƒ

- å¦‚ä½•é–±è®€ "OWASP Top Ten"

- ä½•è¬‚ Injection

- å¸¸è¦‹çš„æ”»æ“Š

- å¦‚ä½•é€²è¡Œä¸€æ¬¡ Injection æ”»æ“Š

- å¦‚ä½•é˜²ç¦¦ Injection æ”»æ“Š

- å…¶ä»– Injection

- æ³•å¾‹æ¬Šç›ŠåŠå…è²¬è²æ˜

- åƒè€ƒè³‡æ–™èˆ‡å»¶ä¼¸é–±è®€

---

class: middle, center

![](https://imgs.xkcd.com/comics/exploits_of_a_mom.png)

---

## ç‚ºä»€éº¼æˆç«‹è³‡å®‰è®€æ›¸æœƒ

- èƒ½ç†è§£ä¸¦é é˜²å¸¸è¦‹çš„è³‡å®‰æ¼æ´
- æª¢é©—ä¸¦æ”¹å–„ç¶²ç«™çš„è³‡å®‰å“è³ª
- ç™¼æ® Hahower åˆ†äº«äº¤æµçš„ç²¾ç¥

---

class: middle, center

![](https://i.imgur.com/RZ6LbDV.png)

---

## OWASP Top Ten Security Risks

ç›®æ¨™ï¼šè®“é–‹ç™¼äººå“¡ã€æ¶æ§‹å¸«ï¼Œä»¥åŠæ•´å€‹çµ„ç¹”äº†è§£æœ€é‡è¦çš„åå¤§ web app å®‰å…¨æ¼æ´

.center[<img src="https://i.imgur.com/LtT4CT9.png" width="300px">]

---

## å¦‚ä½•é–±è®€ OWASP Top Ten

![](https://i.imgur.com/Aw7GjpS.png)

![](https://i.imgur.com/UfxqWDD.png)

- Attack Vectorï¼ˆæ”»æ“Šè¼‰é«”ï¼‰
- Security Weaknessï¼ˆå®‰å…¨å¼±é»ï¼‰
- Impactsï¼ˆå½±éŸ¿ï¼‰

---

## å¦‚ä½•é–±è®€ OWASP Top Ten

![](https://i.imgur.com/7jwNNY6.png)

---

## ä½•è¬‚ Injection

> é€éã€Œæ³¨å…¥æƒ¡æ„ç¨‹å¼ç¢¼ã€åˆ°æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œé€²è€Œå½±éŸ¿æˆ–æ”»æ“Šç³»çµ±çš„è¡Œç‚º

![](https://i.ytimg.com/vi/VbbIsTF-XSQ/hqdefault.jpg)

---

### Non-tech Injection Demo

æƒ³åƒæœ‰ä¸€å°è‡ªå‹•é§•é§›çš„å…¬è»Šï¼Œé€éé å…ˆçµ¦å®šçš„èªéŸ³æŒ‡ä»¤ä¾†é§•è»Š

```bash
é–‹å¾€ <å…¬è·¯åç¨±> ä¸¦åœ¨ <ä»€éº¼æ™‚å€™åœé > æ™‚ <åœé å“ªäº›å…¬è»Šç«™>
```

æ­£å¸¸æƒ…æ³ä¸‹ï¼Œé€™å€‹æŒ‡ä»¤æœƒé•·é€™æ¨£ï¼š

```bash
é–‹å¾€ "å¾©èˆˆåŒ—è·¯" ä¸¦åœ¨ "è»Šä¸Šæœ‰äººæŒ‰éˆ´" æ™‚ "åœé é•·æ˜¥è·¯å£èˆ‡å—äº¬æ±è·¯"
```

æœ‰ä¸€å¤©ï¼Œä¸€ä½ä¸Šç­å¿«é²åˆ°çš„é§­å®¢ C éˆæ©Ÿä¸€å‹•ï¼Œç«„æ”¹é€™å€‹æŒ‡ä»¤ï¼š

```bash
é–‹å¾€ "å¾©èˆˆåŒ—è·¯" ä¸¦åœ¨ "è»Šä¸Šæœ‰äºº" æ™‚ "ä¸åœé ä»»ä½•ç«™"
```

çµæœå…¶ä»–ä¹˜å®¢å°±è·Ÿè‘—é§­å®¢ C ä¸€èµ·åˆ° Hahow ä¸Šç­ã€‚

---

### Injection å±å®³ç¨‹åº¦

![](https://i.imgur.com/UfxqWDD.png)

- åˆ©ç”¨ç¨‹åº¦ï¼šæœ€å®¹æ˜“ 3

- å¼±é»æ™®åŠï¼šæ™®åŠ 2

- å¼±é»åµæ¸¬ï¼šæœ€å®¹æ˜“ 3

- æŠ€è¡“å±å®³ï¼šæœ€åš´é‡ 3

> Injection èŸ¬è¯ OWASP 2010, 2013, 2017 Top 1 å®‰å…¨æ¼æ´

---

### Attack Vector æ”»æ“Šè¼‰é«”

> æ”œå¸¶ã€Œ**çœ‹ä¼¼ç„¡å®³å¯ä¿¡ä»»**ã€çš„ä»»æ„è³‡æ–™é€²å…¥ç³»çµ±çš„å‚³æ’­è€…ã€‚

- ğŸ¤¡ ç’°å¢ƒè®Šæ•¸

- ğŸ¤¡ ç¨‹å¼åƒæ•¸

- ğŸ¤¡ service request payload

- ğŸ¤¡ å„ç¨® user data

---

### Security Weakness å®‰å…¨å¼±é»

> è©²è¦åš´åŠ å–ç· å»ã€Œ**ä»»æ„æ”¾è¡Œ**ã€çš„æª¢æŸ¥å“¨

- ğŸ•³ SQL, NoSQL, XPath ç­‰å„ç¨® query

- ğŸ•³ Shell åŸ·è¡Œå„ç¨®å¤–éƒ¨æŒ‡ä»¤ 

- ğŸ•³ é€é system call å‘¼å« OS

- ğŸ•³ ORM queryï¼ˆæ²’éŒ¯ï¼ŒORM ä¹Ÿä¸å®‰å…¨ï¼‰

- ğŸ•³ å¹¾ä¹æ‰€æœ‰ interpreter

äº‹å¯¦ä¸Šï¼Œinjection å°±æ˜¯æŠŠæƒ¡æ„çš„ expressionï¼Œé€éã€Œå—ä¿¡ä»»ã€çš„ä½ ï¼Œå‚³çµ¦å¦ä¸€å€‹ä¿¡ä»»ä½ çš„å¤–éƒ¨ç¨‹å¼

---

### Impacts å½±éŸ¿

> ç™¼ç”Ÿæ”»æ“Šä¹‹å¾Œå¯èƒ½çš„å½±éŸ¿

- ğŸ’¥ è³‡æ–™éºå¤±ææ¯€

- ğŸ’¥ è³‡æ–™æ´©æ¼

- ğŸ’¥ æ¬Šé™å‡ç´š

- ğŸ’¥ ç³»çµ±å®Œå…¨è¢«æ§åˆ¶

.center[<img src="https://www.pitchina.com.cn/Public/Common/kindeditor/attached/image/20170417/20170417115520_48607.jpeg" width="450px">]

---

class: middle, center

## å¸¸è¦‹çš„ Injection æ”»æ“Š

---

### OS Command Injection

**æƒ…æ³ï¼š**é€é web ä»‹é¢å‚³é€åƒæ•¸ç›´æ¥åŸ·è¡Œ OS command

ä¾‹å¦‚æœ‰ä¸€æ”¯ API èƒŒå¾Œæ˜¯ call `date` é…åˆæ ¼å¼ä¾†é¡¯ç¤ºæ™‚é–“

```rust
// http://sensetive/?format=xxx

fn search() { 
    return system_cmd("date {format}") 
}

//  http://sensetive/?format="+%T" -> "11:30:28"
```

æˆ‘å€‘å‚³å…¥ `&& cat /etc/passwd` å°±å¯ä»¥ç²å¾—ä½¿ç”¨è€…è³‡è¨Š

```bash
http://sensetive/?format=" && cat /etc/passwd" ->

// root:*:0:0:System Administrator:/var/root:/bin/sh
// daemon:*:1:1:System Services:/var/root:/usr/bin/false
// ...
```

---

### OS Command Injection

åŒæ¨£çš„ä»‹é¢ï¼Œæ”»æ“Šè€…æƒ³è¦æˆ‘å€‘æ­»æ›´ç°¡å–®

```bash
http://sensetive/?format=%3Brm%20-rf%20/

system_cmd("date ;rm -rf /")
```

é€™äº› OS command injectionï¼Œä»»ä½•è…³æœ¬èªè¨€ä¸ç¶“æ¶ˆæ¯’ç›´æ¥æŠŠæŒ‡ä»¤ä¸Ÿåˆ° system command å»çµ•å°éå¸¸å±éšªã€‚

---

### SQL Injection

ä¾‹å¦‚æ”»æ“Šè€…æƒ³è¦ä»¥æŸå€‹ä½¿ç”¨è€…èº«åˆ†ç™»å…¥

```ruby
# é€™å€‹ statement æœƒå‚³åˆ° SQL interpreter è£¡
stmt = "SELECT *
FROM users WHERE user = '#{user}' AND pass = '#{pass}'"

# ç•¶æ”»æ“Šè€…å‚³å…¥ user = "admin'; --"ï¼ŒSQL è®Šæˆé€™æ¨£

stmt = "SELECT * 
FROM users WHERE user = 'admin'; --' AND pass = 'anything'"
```

---

### SQL Injection

æˆ–æ˜¯ OWASP çš„ç¯„ä¾‹ï¼ˆå¯ä»¥æ’ˆå‡º æ‰€æœ‰ account è³‡è¨Šï¼‰

```java
String query = "SELECT * FROM accounts WHERE custID='" 
  + request.getParameter("id") 
  + "'";

http://example.com/app/accountView?id='or '1'='1

-> SELECT * FROM accounts WHERE custID='' or '1'='1'
```

---

## å¦‚ä½•é€²è¡Œä¸€æ¬¡ Injection æ”»æ“Š

> ä»¥ SQL injection ç‚ºä¾‹

1. å°‹æ‰¾å‚³å…¥ database çš„åƒæ•¸å°±æ˜¯ Injection çš„é»
  - è‡ªå‹•æ¸¬è©¦å·¥å…· [sqlmap](http://sqlmap.org/)
  - ç›´æ¥çœ‹ source code æ‰¾å•é¡Œ
2. åˆ©ç”¨ Injection weaknessï¼Œå°‡æƒ¡æ„ SQL command è—åœ¨å…¶ä¸­
  - Boolean-Based SQL Injectionï¼šå–„ç”¨ `UNION`ã€`--` èˆ‡ boolean
  - Error-Based SQL Injectionï¼šéŒ¯èª¤è¨Šæ¯æœƒæä¾›å¾ˆå¤šå¯ç”¨è³‡è¨Š
3. å˜—è©¦ Blind SQL injection
  - å¦‚æœæ²’æœ‰éŒ¯èª¤è¨Šæ¯å¯ä»¥çœ‹ï¼Œå°±ç›²è§£å§
  - Time-Based SQL Injection

---

### Time-Based SQL Injection

é€²è¡Œ Blind SQL injection ï¼Œé€éæ™‚é–“ä¾†çŒœ DB è³‡æ–™ã€‚

```bash
# ç‰ˆæœ¬æ˜¯ 5 æ™‚ sleep

http://x.php/?id=10 AND IF(version() like â€˜5%â€™,sleep(10),â€˜falseâ€™))--
```


---

## å¦‚ä½•é˜²ç¦¦ Injection æ”»æ“Š

å…ˆçŸ¥é“å¼±é»å“ªè£¡ä¾†ï¼ˆSecurity Weaknessï¼‰

- æ²’æœ‰é©—è­‰/éæ¿¾/sanitize user-supplied data
- dynamic query æˆ–æ˜¯æ²’ parameterized çš„å‘¼å«ï¼Œæœªè€ƒæ…®ä¸Šä¸‹æ–‡å°±ç›´æ¥é€åˆ° interpreter
- ORM çš„æŸ¥è©¢åƒæ•¸ä¸­å¸¶è‘—æƒ¡æ„è³‡æ–™ä¾†ç«Šå–é¡å¤–æˆ–æ•æ„Ÿè³‡æ–™
- æƒ¡æ„è³‡æ–™è¢«ä¸²æ¥åˆ° query æˆ– command ä¸­

å¯ä»¥é€é **Source Code Review** æª¢æŸ¥å„ç¨® data input

- èƒ½å¤  **parameterize** å°± **parameterize**ï¼Œèƒ½æº–ç¢ºå®šç¾©åƒæ•¸å‹åˆ¥å°±å®šç¾©ï¼Œä¸è¦ç‚ºäº†å½ˆæ€§å‚³å…¥ arbitrary shape çš„è³‡æ–™
- å„ç¨®  data input validationï¼Œå¦‚ header, URL, cookies
- æª¢æŸ¥å„ç¨® call of external resources çš„ åƒæ•¸ï¼Œ**åˆ¥äººå®Œå…¨ä¿¡ä»»ä½ ä½ ä¸è¦å‚·å¥¹çš„å¿ƒ**

---

### Parameterize

Python çš„ [`sqlite3` library](https://docs.python.org/3/library/sqlite3.html) å°±ä½¿ç”¨äº† `?` parameter substitutionï¼Œé˜²æ­¢ arbitrary SQL commandã€‚

```python
# Never do this -- insecure!
symbol = 'RHAT'
c.execute("SELECT * FROM stocks WHERE symbol = '%s'" % symbol)

# Do this instead
t = ('RHAT',)
c.execute('SELECT * FROM stocks WHERE symbol=?', t)
print(c.fetchone())

# Larger example that inserts many records at a time
purchases = [('2006-03-28', 'BUY', 'IBM', 1000, 45.00),
             ('2006-04-05', 'BUY', 'MSFT', 1000, 72.00),
             ('2006-04-06', 'SELL', 'IBM', 500, 53.00),
            ]
c.executemany('INSERT INTO stocks VALUES (?,?,?,?,?)', purchases)
```

---

### å¦‚ä½•é˜²ç¦¦ Injection æ”»æ“Š

**API é¿å…ç›´æ¥ä½¿ç”¨ interpreter**

- å¯ä»¥ä½¿ç”¨èªè¨€æä¾›çš„ lib å°±ç”¨ï¼Œä¸è¦ç›´æ¥ call command
- è‹¥ç‚ºå¿…é ˆå‰‡ä¸€å®šè¦ parameterized ä»‹é¢ã€‚

**æ¬Šé™æ§ç®¡**

- çµ¦è™•ç†é€™äº› interpreter/external command çš„ client å‰›å‰›å¥½çš„æ¬Šé™
- æˆ–æ˜¯æ”¾åœ¨ sandbox/VM/container ä¸­

**é©—è­‰è¼¸å…¥**

- è¼¸å…¥é©—è­‰æ¡å–ã€Œ**æ­£é¢è¡¨åˆ—**ã€ï¼ˆä¸èƒ½ä½œç‚ºå®Œæ•´çš„é˜²ç¦¦ï¼Œæœ‰äº›æ‡‰ç”¨ç¨‹å¼éœ€è¦ arbitrary inputï¼Œä¾‹å¦‚ ~~slate~~ editor)
- ä½¿ç”¨ `LIMIT` æˆ–å…¶ä»– SQL control é˜²æ­¢ injection ç™¼ç”Ÿæ™‚æ´©æ¼éå¤šè³‡æ–™

---

### å¯ä¸å¯ä»¥è‡ªå‹•åŒ–ï¼Ÿ

**CI/CD åŠ ä¸Šæª¢æŸ¥å·¥å…·**
  
[**Static Application Security Testing**](https://www.owasp.org/index.php/Source_Code_Analysis_Tools)(a.k.a static source analysis)

- éœæ…‹åˆ†æç¨‹å¼ç¢¼ï¼Œå®¹æ˜“åœ¨ CI ä¸Šé¢è·‘
- é©åˆæª¢æŸ¥ SQL injection flaw
- å®¹æ˜“æœ‰ false positive æœƒåš‡æ­»äºº

[**Dynamic Application Test**](https://www.owasp.org/index.php/Category:Vulnerability_Scanning_Tools)

- ç›´æ¥å°ç¨‹å¼æƒæå¼±é»ï¼ˆScannerï¼‰
- ç›¸å° Static source analysis ä¾†å¾—æˆæœ¬é«˜

---

class: middle, center

## å…¶ä»– Injection

---

### NoSQL Injection

NoSQL æ™®éè¢«èªç‚ºç¨å¾®å®‰å…¨ä¸€é»ï¼Œå› ç‚º query synxtax æœƒæª¢æŸ¥æ›´å¤šä¸åŒçš„ç¬¦è™Ÿï¼Œä½†å…¶å¯¦ Injection ä»ç„¶ç„¡æ‰€ä¸åœ¨ã€‚ä»¥ MongoDB ç‚ºä¾‹ï¼š


```js
// $where å¯åŸ·è¡Œä»»æ„ JavaScriptï¼Œé¤µå®ƒ user input éå¸¸å±éšª
// æ”»æ“Šè€…å¯ä»¥åšåˆ° denial of access çš„æ”»æ“Š
/
let userInput = "(function(){var a = new Date(); do{curDate = new Date();}while(curDate-date < 10000); return Math.max();})()"

db.collections.find({ $where: `${userInput}` })
```

---

### NoSQL Injection

MongoDB çš„å‚³å…¥ JSON query 

```rust
fn login(username, hashedPassword) {
    return db.users.findOne({ username, hashedPassword });
}

let user = "admin"
let password =   {$gte: ""}

login(user, password)
// db.users.findOne({ username: "admin", hashedPassword: {$gte: ""}})
``` 

é‚„æœ‰ [GraphQL injection](http://www.petecorey.com/blog/2017/06/12/graphql-nosql-injection-through-json-types/)ï¼ˆä½†æˆ‘ä¸ç†Ÿ GraphQL çœ‹ç„¡ï¼‰

---

class: middle, center

## æ³•å¾‹æ¬Šç›ŠåŠå…è²¬è²æ˜

---

#### åˆ‘æ³•ç¬¬ä¸‰åå…­ç«  å¦¨å®³é›»è…¦ä½¿ç”¨ç½ª

ç¬¬ 358 æ¢        
ç„¡æ•…è¼¸å…¥ä»–äººå¸³è™Ÿå¯†ç¢¼ã€ç ´è§£ä½¿ç”¨é›»è…¦ä¹‹ä¿è­·æªæ–½æˆ–åˆ©ç”¨é›»è…¦ç³»çµ±ä¹‹æ¼æ´ï¼Œè€Œå…¥ä¾µä»–äººä¹‹é›»è…¦æˆ–å…¶ç›¸é—œè¨­å‚™è€…ï¼Œè™•ä¸‰å¹´ä»¥ä¸‹æœ‰æœŸå¾’åˆ‘ã€æ‹˜å½¹æˆ–ç§‘æˆ–ä½µç§‘åè¬å…ƒä»¥ä¸‹ç½°é‡‘ã€‚

ç¬¬ 359 æ¢        
ç„¡æ•…å–å¾—ã€åˆªé™¤æˆ–è®Šæ›´ä»–äººé›»è…¦æˆ–å…¶ç›¸é—œè¨­å‚™ä¹‹é›»ç£ç´€éŒ„ï¼Œè‡´ç”Ÿæå®³æ–¼å…¬çœ¾æˆ–ä»–äººè€…ï¼Œè™•äº”å¹´ä»¥ä¸‹æœ‰æœŸå¾’åˆ‘ã€æ‹˜å½¹æˆ–ç§‘æˆ–ä½µç§‘äºŒåè¬å…ƒä»¥ä¸‹ç½°é‡‘ã€‚

ç¬¬ 360 æ¢        
ç„¡æ•…ä»¥é›»è…¦ç¨‹å¼æˆ–å…¶ä»–é›»ç£æ–¹å¼å¹²æ“¾ä»–äººé›»è…¦æˆ–å…¶ç›¸é—œè¨­å‚™ï¼Œè‡´ç”Ÿæå®³æ–¼å…¬çœ¾æˆ–ä»–äººè€…ï¼Œè™•ä¸‰å¹´ä»¥ä¸‹æœ‰æœŸå¾’åˆ‘ã€æ‹˜å½¹æˆ–ç§‘æˆ–ä½µç§‘åè¬å…ƒä»¥ä¸‹ç½°é‡‘ã€‚

ç¬¬ 361 æ¢        
å°æ–¼å…¬å‹™æ©Ÿé—œä¹‹é›»è…¦æˆ–å…¶ç›¸é—œè¨­å‚™çŠ¯å‰ä¸‰æ¢ä¹‹ç½ªè€…ï¼ŒåŠ é‡å…¶åˆ‘è‡³äºŒåˆ†ä¹‹ä¸€ã€‚

ç¬¬ 362 æ¢        
è£½ä½œå°ˆä¾›çŠ¯æœ¬ç« ä¹‹ç½ªä¹‹é›»è…¦ç¨‹å¼ï¼Œè€Œä¾›è‡ªå·±æˆ–ä»–äººçŠ¯æœ¬ç« ä¹‹ç½ªï¼Œè‡´ç”Ÿæå®³æ–¼å…¬çœ¾æˆ–ä»–äººè€…ï¼Œè™•äº”å¹´ä»¥ä¸‹æœ‰æœŸå¾’åˆ‘ã€æ‹˜å½¹æˆ–ç§‘æˆ–ä½µç§‘äºŒåè¬å…ƒä»¥ä¸‹ç½°é‡‘ã€‚

ç¬¬ 363 æ¢        
ç¬¬ä¸‰ç™¾äº”åå…«æ¢è‡³ç¬¬ä¸‰ç™¾å…­åæ¢ä¹‹ç½ªï¼Œé ˆå‘Šè¨´ä¹ƒè«–ã€‚

---

## åƒè€ƒè³‡æ–™èˆ‡å»¶ä¼¸é–±è®€

- [OWASP Top 10 - 2017: The Ten Most Critical Web Application Security Risks](https://www.owasp.org/images/7/72/OWASP_Top_10-2017_%28en%29.pdf.pdf)
- Clarke, J. (2009). [SQL Injection Attacks and Defense 2nd Edition](https://www.amazon.com/Injection-Attacks-Defense-Justin-Clarke/dp/1597499633)ï¼ˆç°¡ä¸­ç‰ˆå…§æ´½ï¼‰
- [Spiegel, P. OWASP NoSQL Injection](https://www.owasp.org/images/e/ed/GOD16-NOSQL.pdf)
- [sqlmap é–‹æºæ»²é€æ¸¬è©¦ SQL injection å·¥å…·](http://sqlmap.org/)
- [commix é–‹æº command injection å·¥å…·](https://github.com/commixproject/commix)
- [Rails çš„ ORM ActiveRecord çš„ Injection å¤§å…¨](https://rails-sqli.org/)
- [Rails çš„é˜²ç¦¦ Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Ruby_on_Rails_Cheatsheet.md)
- [OWASP Injection Prevention Cheat Sheet](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Injection_Prevention_Cheat_Sheet.md) 

---

class: middle, center

# Any advice?

We are from [Hahow å¥½å­¸æ ¡](https://hahow.in/). Ask us anything!

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
